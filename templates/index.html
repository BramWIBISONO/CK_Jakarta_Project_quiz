<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Adventure (Pygame Engine)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { touch-action: none; overflow: hidden; }
        canvas { image-rendering: pixelated; }
        .pixel-font { font-family: 'Courier New', monospace; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-900 flex justify-center items-center h-screen text-white">

    <div class="relative w-[800px] h-[600px] bg-sky-300 overflow-hidden shadow-2xl rounded-xl" id="game-container">
        
        <!-- CANVAS GAME -->
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <!-- UI HUD -->
        <div class="absolute top-4 left-4 flex gap-4 pixel-font">
            <div class="bg-slate-800/80 p-2 rounded border border-slate-500">
                SCORE: <span id="scoreVal" class="text-yellow-400">0</span>
            </div>
            <div class="bg-slate-800/80 p-2 rounded border border-slate-500">
                LEVEL: <span id="levelVal" class="text-emerald-400">1</span>
            </div>
            <div class="bg-slate-800/80 p-2 rounded border border-slate-500 text-xs">
                ENGINE: <span class="text-green-400">PYGAME ACTIVE</span>
            </div>
        </div>

        <!-- CONTROLS HINT (Mobile) -->
        <div class="absolute bottom-4 w-full text-center text-slate-700 font-bold opacity-50 pointer-events-none animate-pulse">
            TAHAN LAYAR KANAN UNTUK JALAN >>
        </div>

        <!-- QUIZ MODAL -->
        <div id="quizModal" class="hidden absolute inset-0 bg-slate-900/90 flex items-center justify-center z-50">
            <div class="bg-slate-800 p-8 rounded-2xl max-w-lg w-full border-2 border-purple-500 shadow-[0_0_50px_rgba(168,85,247,0.5)]">
                <div id="quizCategory" class="text-purple-400 text-sm font-bold mb-2 uppercase tracking-wider">CATEGORY</div>
                <h2 id="quizQuestion" class="text-2xl font-bold mb-6 leading-relaxed">Question?</h2>
                <div id="quizOptions" class="grid gap-3">
                    <!-- Options injected here -->
                </div>
            </div>
        </div>

    </div>

<script>
    // --- CONFIG ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Game State (Frontend Mirror)
    let playerX = 50;
    let cameraX = 0;
    let isMoving = false;
    let gameState = "RUNNING"; // RUNNING, QUIZ
    
    // --- ASSETS DRAWING ---
    function draw() {
        // Clear Screen
        ctx.fillStyle = "#87CEEB"; // Sky
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Ground
        ctx.fillStyle = "#2ecc71";
        ctx.fillRect(0, 510, canvas.width, 90);
        ctx.fillStyle = "#27ae60"; // Grass detailing
        ctx.fillRect(0, 510, canvas.width, 10);

        // Camera Logic
        const renderX = playerX - cameraX;
        
        // Draw Scenery (Parallax Simple)
        ctx.fillStyle = "rgba(255,255,255,0.5)";
        ctx.beginPath();
        ctx.arc(200 - (cameraX * 0.2), 100, 40, 0, Math.PI*2); // Cloud 1
        ctx.fill();

        // Draw Player
        ctx.fillStyle = "#e74c3c"; // Red Shirt
        ctx.fillRect(renderX, 450, 40, 60);
        ctx.fillStyle = "#f1c40f"; // Face
        ctx.fillRect(renderX + 5, 430, 30, 20);
        
        // Legs Animation
        if(isMoving) {
            const legOffset = Math.sin(Date.now() / 100) * 10;
            ctx.fillStyle = "#34495e";
            ctx.fillRect(renderX + 5 + legOffset, 510, 10, 15);
            ctx.fillRect(renderX + 25 - legOffset, 510, 10, 15);
        } else {
            ctx.fillStyle = "#34495e";
            ctx.fillRect(renderX + 5, 510, 10, 15);
            ctx.fillRect(renderX + 25, 510, 10, 15);
        }

        // Draw Checkpoints (Visual Only, Logic di Server)
        const checkPoints = [400, 900, 1500, 2100, 2600, 3200];
        checkPoints.forEach(x => {
            const cpRenderX = x - cameraX;
            if (cpRenderX > -100 && cpRenderX < 800) {
                // Tiang
                ctx.fillStyle = "#8e44ad";
                ctx.fillRect(cpRenderX, 400, 10, 110);
                // Box Tanya
                ctx.fillStyle = "#9b59b6";
                ctx.fillRect(cpRenderX - 20, 350, 50, 50);
                ctx.fillStyle = "#fff";
                ctx.font = "30px Arial";
                ctx.fillText("?", cpRenderX - 5, 385);
            }
        });

        requestAnimationFrame(draw);
    }

    // --- LOGIC LOOP ---
    // Kita kirim input ke server secara berkala, bukan setiap frame (agar tidak lag)
    setInterval(() => {
        if (gameState !== "RUNNING") return;
        
        if (isMoving) {
            // Prediksi lokal (agar smooth di mata user)
            playerX += 5; 
            if (playerX > 300) cameraX = playerX - 300;

            // Sync dengan Server Pygame
            fetch('/api/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: "right" })
            })
            .then(res => res.json())
            .then(data => {
                // Koreksi posisi dari otoritas server (Pygame)
                // playerX = data.player_x; // Uncomment jika ingin strict sync
                
                // Update UI Score
                document.getElementById('scoreVal').innerText = data.score;
                document.getElementById('levelVal').innerText = data.level;

                // Cek apakah Pygame mendeteksi collision Quiz
                if (data.status === "QUIZ" && gameState !== "QUIZ") {
                    showQuiz(data.quiz_data);
                }
            });
        }
    }, 1000 / 30); // 30 FPS Network tick

    // --- QUIZ UI ---
    function showQuiz(qData) {
        gameState = "QUIZ";
        isMoving = false; // Stop movement
        const modal = document.getElementById('quizModal');
        const optsContainer = document.getElementById('quizOptions');
        
        document.getElementById('quizCategory').innerText = qData.category;
        document.getElementById('quizQuestion').innerText = qData.question;
        optsContainer.innerHTML = "";

        qData.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = "p-4 bg-slate-700 hover:bg-purple-600 rounded-xl text-left font-semibold transition-colors border border-slate-600";
            btn.innerText = opt;
            btn.onclick = () => submitAnswer(idx);
            optsContainer.appendChild(btn);
        });

        modal.classList.remove('hidden');
    }

    function submitAnswer(idx) {
        fetch('/api/answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ answer_idx: idx })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('quizModal').classList.add('hidden');
            gameState = "RUNNING";
            
            // Update stats
            document.getElementById('scoreVal').innerText = data.score;
            document.getElementById('levelVal').innerText = data.level;
            
            // Sync posisi agar melewati checkpoint
            playerX = data.player_x;
        });
    }

    // --- CONTROLS ---
    const container = document.getElementById('game-container');
    
    // Touch / Mouse
    container.addEventListener('mousedown', () => isMoving = true);
    container.addEventListener('mouseup', () => isMoving = false);
    container.addEventListener('touchstart', (e) => { e.preventDefault(); isMoving = true; });
    container.addEventListener('touchend', (e) => { e.preventDefault(); isMoving = false; });

    // Keyboard
    window.addEventListener('keydown', (e) => {
        if(e.key === "ArrowRight") isMoving = true;
    });
    window.addEventListener('keyup', (e) => {
        if(e.key === "ArrowRight") isMoving = false;
    });

    // Start Drawing Loop
    draw();

</script>
</body>
</html>